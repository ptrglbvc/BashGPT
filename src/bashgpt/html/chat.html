{% extends "layout.html" %} {% block title %}{{ chat_info.description }}{%
endblock %} {% block content %}
<main class="chat-container">
    <div class="messages-container">
        {% for message in messages %}
        <div class="message-wrapper {{ message.role }}">
            <div class="message">
                <div class="message-content">
                    <div
                        class="message-text preserve-whitespace"
                        data-raw-text="{{message['content']}}"
                    >
                        {{message["content"]|safe}}
                    </div>
                    {% if message.role == "assistant" %}
                    <div class="message-actions">
                        <button
                            class="message-action-btn copy-message"
                            title="Copy message"
                        >
                            <i class="fa-solid fa-copy"></i>
                        </button>
                        <button
                            class="message-action-btn regenerate-message"
                            title="Regenerate"
                        >
                            <i class="fa-solid fa-rotate"></i>
                        </button>
                        <button
                            class="message-action-btn continue-message"
                            title="Continue"
                        >
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                    {% endif %} {% for image in images %} {% if
                    image.message_idx == message.message_id %}
                    <div class="message-image">
                        <img
                            src="data:image/{{ image.extension }};base64,{{ image.content }}"
                            alt="{{ image.name }}"
                        />
                    </div>
                    {% endif %} {% endfor %} {% for file in files %} {% if
                    file.message_idx == message.message_id %}
                    <div class="message-file">
                        <i class="fa-solid fa-file"></i>
                        <span>{{ file.name }}</span>
                    </div>
                    {% endif %} {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</main>
{% endblock %} {% block form_logic %}
<script>
    async function send_message(message) {
        return await fetch("/api/answer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message }),
        });
    }

    function createMessageElement(role, message = "") {
        const messageWrapper = document.createElement("div");
        messageWrapper.className = `message-wrapper ${role}`;

        const messageDiv = document.createElement("div");
        messageDiv.className = "message";

        const messageContentDiv = document.createElement("div");
        messageContentDiv.className = "message-content";

        const messageText = document.createElement("div");
        messageText.className = "message-text preserve-whitespace";
        messageText.setAttribute("data-raw-text", message);
        messageText.innerHTML = marked.parse(message);

        messageWrapper.appendChild(messageDiv);
        messageDiv.appendChild(messageContentDiv);
        messageContentDiv.appendChild(messageText);

        if (role === "assistant") {
            const messageActions = document.createElement("div");
            messageActions.className = "message-actions";

            const copyBtn = document.createElement("button");
            copyBtn.className = "message-action-btn copy-message";
            copyBtn.title = "Copy message";
            copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i>';
            copyBtn.addEventListener("click", () => copyMessage(messageText));

            const regenerateBtn = document.createElement("button");
            regenerateBtn.className = "message-action-btn regenerate-message";
            regenerateBtn.title = "Regenerate";
            regenerateBtn.innerHTML = '<i class="fa-solid fa-rotate"></i>';
            regenerateBtn.addEventListener("click", () =>
                regenerateMessage(messageWrapper)
            );

            const continueBtn = document.createElement("button");
            continueBtn.className = "message-action-btn continue-message";
            continueBtn.title = "Continue";
            continueBtn.innerHTML = '<i class="fa-solid fa-arrow-right"></i>';
            continueBtn.addEventListener("click", () =>
                continueMessage(messageWrapper)
            );

            messageActions.appendChild(copyBtn);
            messageActions.appendChild(regenerateBtn);
            messageActions.appendChild(continueBtn);
            messageContentDiv.appendChild(messageActions);
        }

        return messageWrapper;
    }

    function copyMessage(messageElement) {
        const rawText = messageElement.getAttribute("data-raw-text");
        navigator.clipboard
            .writeText(rawText)
            .then(() => {
                const copyBtn =
                    messageElement.nextElementSibling.querySelector(
                        ".copy-message"
                    );
                const originalIcon = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = originalIcon;
                }, 2000);
            })
            .catch((err) => {
                console.error("Failed to copy message:", err);
            });
    }

    function regenerateMessage(messageWrapper) {
        console.log("Regenerate message:", messageWrapper);
    }

    function continueMessage(messageWrapper) {
        console.log("Continue message:", messageWrapper);
    }

    // Add event listeners to existing messages
    document.addEventListener("DOMContentLoaded", function () {
        document
            .querySelectorAll(".message-wrapper.assistant")
            .forEach((messageWrapper) => {
                const messageText =
                    messageWrapper.querySelector(".message-text");
                const messageContent =
                    messageWrapper.querySelector(".message-content");
                const copyBtn = messageContent.querySelector(".copy-message");

                if (copyBtn) {
                    copyBtn.addEventListener("click", function () {
                        const rawText =
                            messageText.getAttribute("data-raw-text");
                        navigator.clipboard
                            .writeText(rawText)
                            .then(() => {
                                const originalIcon = this.innerHTML;
                                this.innerHTML =
                                    '<i class="fa-solid fa-check"></i>';
                                setTimeout(() => {
                                    this.innerHTML = originalIcon;
                                }, 2000);
                            })
                            .catch((err) => {
                                console.error("Failed to copy message:", err);
                            });
                    });
                }

                const regenerateBtn = messageContent.querySelector(
                    ".regenerate-message"
                );
                if (regenerateBtn) {
                    regenerateBtn.addEventListener("click", function () {
                        regenerateMessage(messageWrapper);
                    });
                }

                const continueBtn =
                    messageContent.querySelector(".continue-message");
                if (continueBtn) {
                    continueBtn.addEventListener("click", function () {
                        continueMessage(messageWrapper);
                    });
                }
            });
    });

    function isUserAtBottom() {
        const tolerance = 15; // Pixels of tolerance to consider "at bottom"
        return (
            window.innerHeight + window.scrollY >=
            document.body.offsetHeight - tolerance
        );
    }

    const urlParams = new URLSearchParams(window.location.search);
    const params = {};
    for (const [key, value] of urlParams) {
        params[key] = value;
    }

    if (params["new_chat"] == "true") {
        wasAtBottom = isUserAtBottom();
        message = "";
        get_assistant_response(message, wasAtBottom);
    }

    let shoudlAutoScroll = false;

    // this handles the message sending part
    document
        .getElementById("message-form")
        .addEventListener("submit", async function (e) {
            e.preventDefault();
            const message = textarea.value.trim();
            if (!message) return;
            console.log(message);

            const wasAtBottom = isUserAtBottom();

            textarea.value = "";
            textarea.style.height = "auto";

            let user_message = createMessageElement("user", message);

            let messages_container = document.querySelector(
                ".messages-container"
            );

            messages_container.appendChild(user_message, message);

            get_assistant_response(message, wasAtBottom);

            // Scroll to bottom after adding user message if they were already at bottom
            if (wasAtBottom) {
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: "smooth",
                });
            }
        });

    async function get_assistant_response(message, wasAtBottom) {
        let assistant_message = createMessageElement("assistant");
        let assistant_message_text =
            assistant_message.querySelector(".message-text");
        assistant_message_text.setAttribute("data-raw-text", ""); // Initialize raw text

        let messages_container = document.querySelector(".messages-container");
        messages_container.appendChild(assistant_message);

        res = await send_message(message);
        const reader = res.body.getReader();
        let output = "";
        const observer = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
                if (
                    mutation.type === "childList" &&
                    mutation.addedNodes.length > 0
                ) {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1 && node.matches("pre")) {
                            attach_copy_button_to_code_block(node);
                        }
                    });
                }
            }
        });

        const observer_config = { childList: true, subtree: true };
        observer.observe(assistant_message_text, observer_config);

        while (true) {
            const { done, value } = await reader.read();
            if (done) {
                observer.disconnect();
                assistant_message_text
                    .querySelectorAll("pre")
                    .forEach((pre) => {
                        if (!pre.querySelector(".code-copy-button")) {
                            attach_copy_button_to_code_block(pre);
                        }
                    });
                return;
            }

            const decodedValue = new TextDecoder().decode(value);
            output += decodedValue;
            // Update the raw text attribute
            const currentRawText =
                assistant_message_text.getAttribute("data-raw-text") || "";
            assistant_message_text.setAttribute(
                "data-raw-text",
                currentRawText + decodedValue
            );

            assistant_message_text.innerHTML = marked.parse(
                output.replace(/</g, "&lt;").replace(/>/g, "&gt;")
            );

            if (wasAtBottom) {
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: "auto",
                });
            }
        }
    }
</script>

{% endblock %}
